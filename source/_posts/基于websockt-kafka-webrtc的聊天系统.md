---
title: 基于websockt+kafka+webrtc的聊天系统
tags:
  - reactjs
  - 项目
  - project
categories:
  - 个人项目
date: 2017-12-15 23:28:14
---

### 功能要求
web端的聊天系统非常多，本系统的初哀是在项目协作平台中方便项目经理、产品、开发、测试、运维之间端沟通。
- 建立在企业员工体系基础上，有角色、部门的概念
- 相互之间能够实时传输文本、图片、表情
- 能够传输文件，包括大型文件
- 能够感知对方在线状况
- 离线状态下能够缓存消息
- 能够拉出历史记录，清空、删除历史记录

### 整体架构
![](/images/chat_1.png)

#### 前端
- 页面展示：页面基于react开发，redux做逻辑计算
- 服务通信：websocket做通信协议，直接采用的socket.io
- 历史记录：indexdb做历史数据存储，会对不同的聊天对象建立索引，以便于拉去数据
里面会涉及到的细节问题（浏览器版本会受限制）
    - 打开页面拉去10条历史
    - 鼠标上滚动对历史数据翻页拉去
    - 及时聊天记录到插入
    - 翻页过程中收到新消息可能导致的拉取数据重复
- 表情：emoji-mart
- 文件：
	- 小文件dataUrl传输，存放在indexdb，历史记录会保存；
	- 大文件通过webrtc传输，建立file blob对象，页面刷新会丢失
- 消息提示：浏览器内置的notication作为弹框
后来由于浏览器更新，不能在http下使用，采用chrome 扩展插件解决这个问题
 

#### 后端
- 服务端采用nodejs开发
- redis做在线状态存储，每个人的上下线状态聚合到redis中，有个定时进程每个3s 检查下redis数据是否update，以便及时通过websocket更新给client
因此人员状态实时性要求不是很高
- kafka存放消息，
	- 消费者：每个人都定位成消费者，其对应一个topic（这个可能不合理）；
离线状态时候，消息来个各方的消息会缓存在kafka中，一旦上线后就消费这些缓存消息
	- 生产者：每个人都可以是生产者，当然系统消息、管理员消息 等这些高级等生产者也是存在的
- zookeeper代理3个kafka
- haproxy做负载均衡
cookie serverid insert 保持http连接的持续性
- docker 支撑后端部署


#### p2p通信
在传输大文件的时候，通过websocket已经显得力不从心，还到kafka中绕一圈，着实多走弯路来。
- 小于100kb到采用websocket，保证数据到缓存性质。
- 超过的切换成使用webrtc技术，他属于较新的点对点通信模式，为语音和视频而生，用来传输文件非常靠谱。
- 依赖NAT穿透技术，采用了peerjs-server；他本身基于TURN协议，就是用一个server来管理大家的的详细地址。
[ICE协议下NAT穿越的实现（STUN&TURN）](https://www.jianshu.com/p/84e8c78ca61d)
- 限制：要求对方必须在线



